<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>micro</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      background: #fff;
      color: #333;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
      line-height: 1.5;
      font-size: 12px;
    }

    #container {
      max-width: 560px;
      margin: 0 auto;
      padding: 2rem 1.25rem;
    }

    header {
      margin-bottom: 1.5rem;
    }

    header h1 {
      font-size: 1rem;
      font-weight: normal;
      color: #999;
    }

    #filter-bar {
      display: none;
      align-items: center;
      gap: 0.4rem;
      margin-bottom: 1rem;
      font-size: 0.8rem;
      color: #999;
    }

    #filter-bar.active { display: flex; }

    #filter-bar .clear-filter {
      cursor: pointer;
      color: #ccc;
      text-decoration: none;
    }

    #filter-bar .clear-filter:hover { color: #333; }

    .post {
      padding: 1.25rem 0;
      border-bottom: 1px solid #eee;
    }

    .post:last-child {
      border-bottom: none;
    }

    .post-title {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 0.2rem;
    }

    .post-text {
      font-size: 0.9rem;
      line-height: 1.5;
      word-wrap: break-word;
    }

    .post-text.collapsed {
      display: -webkit-box;
      -webkit-line-clamp: 4;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .post-toggle {
      background: none;
      border: none;
      color: #999;
      cursor: pointer;
      font-size: 0.8rem;
      padding: 0.15rem 0 0;
      font-family: inherit;
    }

    .post-toggle:hover { color: #333; }

    .post-text a {
      color: #333;
      text-decoration: underline;
    }

    .post-meta {
      margin-top: 0.35rem;
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 0.4rem;
      font-size: 0.75rem;
      color: #bbb;
    }

    .post-time {
      cursor: default;
    }

    .tag {
      color: #bbb;
      cursor: pointer;
    }

    .tag:hover { color: #666; }

    #empty {
      color: #ccc;
      font-size: 0.9rem;
      margin-top: 2rem;
    }
    .post-text p { margin: 0 0 0.5em; }
    .post-text p:last-child { margin-bottom: 0; }
    .post-text em { font-style: italic; }
    .post-text strong { font-weight: 600; }
    .post-text code { background: #f5f5f5; padding: 0.1em 0.3em; border-radius: 2px; font-size: 0.85em; }
    .post-text pre { background: #f5f5f5; padding: 0.5em; border-radius: 2px; overflow-x: auto; margin: 0.5em 0; }
    .post-text pre code { background: none; padding: 0; }
    .post-text ul, .post-text ol { margin: 0.3em 0 0.3em 1.2em; }
    .post-text blockquote { border-left: 2px solid #ddd; margin: 0.3em 0; padding-left: 0.6em; color: #888; }
  </style>
</head>
<body>
  <div id="container">
    <header>
      <h1>kyle microblog</h1>
    </header>
    <div id="filter-bar">
      <span>showing:</span>
      <span id="filter-tag"></span>
      <a class="clear-filter" id="clear-filter">&times;</a>
    </div>
    <div id="feed"></div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    const feed = document.getElementById('feed');
    const filterBar = document.getElementById('filter-bar');
    const filterTagEl = document.getElementById('filter-tag');
    const clearFilterEl = document.getElementById('clear-filter');
    let activeFilter = null;

    function formatTime(iso) {
      const d = new Date(iso);
      const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
      const hours = String(d.getHours()).padStart(2, '0');
      const minutes = String(d.getMinutes()).padStart(2, '0');
      return months[d.getMonth()] + ' ' + d.getDate() + ', ' + hours + ':' + minutes;
    }

    marked.setOptions({ breaks: true, gfm: true });

    function filterByTag(tag) {
      activeFilter = tag;
      filterTagEl.textContent = '#' + tag;
      filterBar.classList.add('active');
      document.querySelectorAll('.post').forEach(el => {
        const tags = JSON.parse(el.dataset.tags);
        el.style.display = tags.includes(tag) ? '' : 'none';
      });
    }

    function clearFilter() {
      activeFilter = null;
      filterBar.classList.remove('active');
      document.querySelectorAll('.post').forEach(el => {
        el.style.display = '';
      });
    }

    clearFilterEl.addEventListener('click', clearFilter);

    function renderPosts(posts) {
      if (!posts.length) {
        feed.innerHTML = '<p id="empty">nothing here yet.</p>';
        return;
      }
      posts.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
      posts.forEach(post => {
        const div = document.createElement('div');
        div.className = 'post';
        div.dataset.tags = JSON.stringify(post.tags || []);

        if (post.title) {
          const titleDiv = document.createElement('div');
          titleDiv.className = 'post-title';
          titleDiv.textContent = post.title;
          div.appendChild(titleDiv);
        }

        const textDiv = document.createElement('div');
        textDiv.className = 'post-text';
        textDiv.innerHTML = marked.parse(post.text);
        div.appendChild(textDiv);

        const isLong = (post.text.split('\n').length > 4) || (post.text.length > 300);
        if (isLong) {
          textDiv.classList.add('collapsed');
          const btn = document.createElement('button');
          btn.className = 'post-toggle';
          btn.textContent = 'show more';
          btn.addEventListener('click', () => {
            const collapsed = textDiv.classList.toggle('collapsed');
            btn.textContent = collapsed ? 'show more' : 'show less';
          });
          div.appendChild(btn);
        }

        let metaHtml = '<span class="post-time">' + formatTime(post.timestamp) + '</span>';
        if (post.tags && post.tags.length) {
          post.tags.forEach(tag => {
            metaHtml += ' <span class="tag" data-tag="' + tag + '">#' + tag + '</span>';
          });
        }
        const metaDiv = document.createElement('div');
        metaDiv.className = 'post-meta';
        metaDiv.innerHTML = metaHtml;
        div.appendChild(metaDiv);

        metaDiv.querySelectorAll('.tag').forEach(pill => {
          pill.addEventListener('click', () => filterByTag(pill.dataset.tag));
        });
        feed.appendChild(div);
      });
    }

    fetch('posts.json')
      .then(r => r.json())
      .then(renderPosts)
      .catch(() => {
        feed.innerHTML = '<p id="empty">could not load posts.</p>';
      });
  </script>
</body>
</html>
